# PHD demo

Demonstration of a thesis workflow based on pandoc and paged.js


## Table of Contents

- [Requirements](#requirements)
- [Quick Start](#quick-start)
- [Workflow](#workflow)
- [Generate PDF](#generate-pdf)
- [Pandoc commands](#pandoc-commands)
  - [Generate complete document](#generate-complete-document)
  - [Alternative: Generate with Pandoc's table of contents](#alternative-generate-with-pandocs-table-of-contents)
  - [Generate individual chapter files](#generate-individual-chapter-files)
- [Files organisation](#files-organisation)
  - [src/](#src)
  - [meta.yml](#metayml)
  - [pandoc/](#pandoc)
  - [assets/](#assets)
  - [output/](#output)
  - [pagedjs-phd/](#pagedjs-phd)
  - [pagedjs-phd-config.json](#pagedjs-phd-configjson)
- [Troubleshooting](#troubleshooting)
- [Roadmap](#roadmap-to-do)


## Requirements

- [Pandoc](https://pandoc.org/), the universal converter
- [Better Bibtex for Zotero](https://retorque.re/zotero-better-bibtex/) for generating citation keys
- Code-writing software like [VS codium](https://vscodium.com/)
- Local server (install the Live server extension in VS Codium for example)
- Web browser (caution: there may be differences in rendering between browsers)


## Quick Start

1. **Create the output directory** (if it doesn't exist):
   ```bash
   mkdir output
   ```

2. **Generate your HTML file** with Pandoc:
   ```bash
   pandoc --defaults pandoc/files.yaml --template=pandoc/template.html --metadata-file meta.yaml --lua-filter=pandoc/add_section_ids.lua --lua-filter=pandoc/update-image-paths.lua --citeproc -o output/print.html
   ```

3. **Start a local server** (e.g., with Live Server extension in VS Codium)

4. **View the result** in your browser at `localhost:5500/output/print.html` (the port number may vary depending on your local server configuration)

5. **Edit your content** in `src/` folder and regenerate the HTML file each time you make changes


## Workflow

- Every time you change something in the markdown files, use the Pandoc command to regenerate your html file
- The local server (Live Server) can automatically reload the page when the HTML file changes
- You can customize the visual output by editing the CSS modules in `assets/css/modules/`
- To update the configuration (notes, table of content, figures), edit `pagedjs-phd-config.json`
- Don't forget to add new markdown files to `pandoc/files.yaml` to include them in the final document


## Generate PDF

Once your HTML file is generated and displayed in the browser:

1. Open the file in your browser (`localhost:5500/output/print.html`)
2. Wait for Paged.js to finish rendering all pages
3. Use the browser's print function:
   - **Chrome/Chromium**: File → Print or Ctrl+P (Cmd+P on Mac)
   - **Firefox**: File → Print or Ctrl+P (Cmd+P on Mac)
4. In the print dialog:
   - Destination: "Save as PDF"
   - Paper size: A4 (or your chosen format)
   - Margins: None
   - Background graphics: Enabled
5. Save the PDF

**Note:** For best results, use Chrome or a Chromium-based browser (Edge, Brave, etc.) as they have better support for CSS print features.


## Pandoc commands

### Generate complete document

Create a single HTML file with all content (cover, chapters, bibliography, etc.):

```bash
pandoc --defaults pandoc/files.yaml --template=pandoc/template.html --metadata-file meta.yaml --lua-filter=pandoc/add_section_ids.lua --lua-filter=pandoc/update-image-paths.lua --citeproc -o output/print.html
```

**Note:** The table of contents is automatically generated by Paged.js based on the configuration in `pagedjs-phd-config.json`. You don't need to use Pandoc's `--table-of-contents` flag unless you specifically want Pandoc to generate it instead.

### Alternative: Generate with Pandoc's table of contents

If you prefer to use Pandoc's built-in table of contents:

```bash
pandoc --defaults pandoc/files.yaml --table-of-contents --template=pandoc/template.html --metadata-file meta.yaml --lua-filter=pandoc/add_section_ids.lua --lua-filter=pandoc/update-image-paths.lua --citeproc -o output/print.html
```

### Generate individual chapter files

Create a separate HTML file for each chapter (useful for testing or printing individual chapters):

```bash
for file in src/chapters/*.md; do
	filename=$(basename -- "$file" .md)
	pandoc src/cover.md "$file" --template=pandoc/template.html --metadata-file meta.yaml --lua-filter=pandoc/add_section_ids.lua --lua-filter=pandoc/update-image-paths.lua --citeproc -o "output/${filename}-print.html"
done
```

**Explanation of the command:**
- `--defaults pandoc/files.yaml` → loads the list of input files
- `--template=pandoc/template.html` → uses the custom HTML template
- `--metadata-file meta.yaml` → loads metadata (title, author, etc.)
- `--lua-filter=pandoc/add_section_ids.lua` → adds section IDs based on file names
- `--lua-filter=pandoc/update-image-paths.lua` → standardizes image paths
- `--citeproc` → processes citations and generates bibliography
- `-o output/print.html` → specifies the output file



## Files organisation



### src/

Folder with all your content. 

- `chapters/` → the markdown files of each chapter, please respect the denomination for the chapters (`chapter-01.md`, `chapter-02.md`, etc.)
- `cover.md`, `abstract.md`, `introduction.md`, `conclusion.md`, `credits.md` → add directly the markdown files you need (don't forget to add these files to `pandoc/files.yaml`)
- `generated/` → folder of specific files for generated content (table of content, list of figures, list of tables) / You can change the titles but be careful with html div
- `images/` → put here the images of your content
- `biblio/`
  - `biblio.bib` → the file of your bibliography export from zotero
  - `chicago-full-note.csl` → chosen citation style in Citation Style Language (CSL). See here the complete list of style you can choose → https://github.com/citation-style-language/styles (download the correct one and replace it)

### `meta.yml`

File with metadata that you can reuse in pandoc template (title, author, affiliation) ... + path to your bibliographic files (maybe you need to update if you change the citation style)


### pandoc/

- `files.yaml` → list of all the markdown files used in your content (add or remove files here to include them in the final document)
- `template.html` → HTML template for Pandoc output (defines the structure of the generated HTML file)
- `add_section_ids.lua` → Lua filter that wraps each markdown file content in an HTML `<section>` tag with an ID based on the filename (e.g., content from `abstract.md` becomes `<section id="abstract">...</section>`)
- `update-image-paths.lua` → Lua filter that standardizes image paths to use the base directory structure (`../src/images/`)

### assets/

- `css/` → folder with your css separate in different modules. If you want to add a module, don't forget to import it in `style.css`, import also the style sheet of your fonts like this:

  ```
  @import "../fonts/Brill_webfont/stylesheet.css";
  ```

  Available CSS modules:
  - `modules/var.css` → CSS variables (colors, fonts, spacing)
  - `modules/layout.css` → page layout and margins
  - `modules/text.css` → typography and text styles
  - `modules/figure.css` → figure and image styles
  - `modules/footnotes.css` → footnote styles
  - `modules/sidenotes.css` → sidenote styles
  - `modules/margin-notes.css` → margin note styles
  - `modules/titles.css` → heading styles
  - `modules/titles-counter.css` → heading numbering
  - `modules/introduction-conclusion.css` → styles for introduction and conclusion sections
  - `modules/cover.css` → cover page styles
  - `modules/table-of-content.css` → table of contents styles
  - `modules/toc-counters.css` → table of contents numbering
  - `modules/leaders.css` → leader dots for table of contents
  - `modules/frontmatter.css` → front matter section styles
  - `modules/biblio.css` → bibliography styles
  - `modules/backmatter.css` → back matter section styles

- `fonts/` → add this folder with your fonts

- `js/` → Folder where you can add your custom Javascript. Use [handlers](https://pagedjs.org/documentation/10-handlers-hooks-and-custom-javascript/) from Paged.js. Don’t forget to load your custom file in `pagedjs-phd-config.json`

### output/

Create this directory if it doesn't exist, before launching Pandoc command. It's where your content is generated



### pagedjs-phd/

  A ready-to-start Paged.js environment with preloaded plugins and interface to view pages. License: MIT license, Julie Blanc.

  This folder contains:
  - `paged.esm.js` → Paged.js core library (ES module)
  - `main-script.js` → Main initialization script
  - `pluginsRegistry.js` → Plugin registry and loader
  - `css/` → Interface styles (baseline, page display, recto-verso view)
  - `plugins/` → Pre-installed plugins:
    - `tableOfContent.js` → Automatic table of contents generation
    - `listFigures.js` → Automatic list of figures generation
    - `inlineNotes.js` → Inline notes from Pandoc footnotes
    - `sidenotes.js` → Sidenote positioning and rendering
    - `marginNotes.js` → Margin note positioning and rendering
    - `floatElems.js` → Floating elements management
    - `fullPage.js` → Full-page elements support
    - `pandocTransform.js` → Pandoc HTML structure transformations
    - `reload-in-place.js` → Auto-reload without losing page position

  Normally, you don't need to modify anything here. All configuration is done through `pagedjs-phd-config.json`.



### pagedjs-phd-config.json

You can configure some paged.js features in this file (works only with the pagedjs-phd environment):

#### Update the path of your stylesheet

```json
 "style": {
        "directory": "/assets/css",
        "files": [
            "style.css"   
        ]
    },
```

- `"directory"` → path of the directory
- `"files"` → files of the style, you can add multiple ones    


#### Table of content

```json
"toc": {
    "enabled": true,
    "container": "#toc_container",
    "titles": [
        ".chapter h2", 
        ".chapter h3"
    ],
    "beforepagenumber": "" 
}
```

- `"enabled": true` → Enables or disables the table of contents display 
- `"container"` → Specifies the container element where the table of contents will be inserted (find it in toc.md)
- `"titles"` → List of title levels to include in the table of contents; additional levels can be added or removed / by default: "h2", "h3"
- `"beforepagenumber"` → Customizes text or symbols to display before the page number (if applicable)

Note: the style of the table of content can be customize into this CSS folders:
- `assets/css/modules/table-of-content.css` → global styles
- `assets/css/modules/leaders.css` → add leaders to your table
- `assets/css/modules/toc-counters.css` → add counters before each toc element (don't forget to change in the same way into `title-counter.css`)


#### Figures

Configure automatic figure numbering and generate a list of figures:

```json
"figures": {
    "enabled": true,
    "selector": "figure:not(.unlisted)",
    "counters": true,
    "textBeforeCounters": "Figure ",
    "textAfterCounters": ". ",
    "list": [
        {
            "container": "#list-figures_container",
            "beforepagenumber": ""
        }
    ]
}
```

- `"enabled"` → Enables or disables automatic figure numbering
- `"selector"` → CSS selector to target figures (use `:not(.unlisted)` to exclude specific figures from numbering, add the class `.unlisted` in your content)
- `"counters"` → Enables or disables counter display before figure captions
- `"textBeforeCounters"` → Text displayed before the figure number (e.g., "Figure ", "Fig. ")
- `"textAfterCounters"` → Text displayed after the figure number (e.g., ". ", " - ")
- `"list"` → Configuration for generating list of figures
  - `"container"` → Specifies the container element where the list of figures will be inserted (find it in `src/generated/list-of-figures.md`)
  - `"beforepagenumber"` → Customizes text or symbols to display before the page number (e.g., "Page", "p.")

Note: the style of the list of figures can be customized in `assets/css/modules/figure.css`


#### Notes

Determine if you want footnotes, sidenotes or margin-notes (create the correct HTML, styles need to be added in your custom css)

```json
"notes": {
    "enabled": true,
    "type": "footnote",
    "resetCounter": ".chapter",
    "callInput": ".footnote-ref", 
    "containerNotes": "#footnotes"
}
```

- `"enabled": true` →  Enables or disables the notes feature (it will inline the notes in list from Pandoc)
- `"type"` → Specifies the type of notes. Option avaible: `"footnote"`, `"sidenote"`, `"margin-note"`
- `"resetCounter"`→ CSS element where the counter note reset (if you want to reset on the page: `"page"`, reset on the page work only with footnotes)
- `"callInput"` → Identifies the elements used to reference notes in the text / by default: ".footnote-ref"
- `"containerNotes"` → Specifies the container element where the notes are displayed by pandoc (this element is deleted after rendering) / by default: "#footnotes" 


It’s also possible to make sidenotes (`"type": "sidenote"`) or margin notes (`"type": "margin-note"`) and specify some parameters:


```json
"notes": {
    "enabled": true, 
    "type": "sidenote", 
    "resetCounter": ".chapter", 
    "callInput": ".footnote-ref", 
    "containerNotes": "#footnotes", 
    "params": { 
        "position": "outside", 
        "align": ".first-paragraph" 
    }
}
```

- `"position"` → Determines the placement of the notes in the page: `"outside"`, `"inside"`, `"left"`, `"right"` / default: `"outside"`
- `"align"` → Determines the top alignment of the sidenote relative to this element (the first on the page) / works only for sidenotes


#### Custom Script (handlers)

You can add your custom Javascript. For this, use [handlers](https://pagedjs.org/documentation/10-handlers-hooks-and-custom-javascript/) from Paged.js [(see documentation)](https://pagedjs.org/documentation/10-handlers-hooks-and-custom-javascript/). Add your files in `/assets/js/` and load your custom file like this:


```json
"customHandlers": {
    "directory": "/assets/js", 
    "files": [
        "custom-handler-example-1.js",
        "custom-handler-example-2.js" 
    ]
}
```

- `"directory"` → path of the directory
- `"files"` → your js files with custom handlers   


Template to create handlers with paged.esm.js (module ECMAScript.):

```javascript
import { Handler } from '/pagedjs-phd/paged.esm.js';

export default class myCustomHandler extends Handler {
    constructor(chunker, polisher, caller) {
        super(chunker, polisher, caller);
    }

    beforeParsed(content){
        // ...
    }
}
```


## Troubleshooting

### The local server doesn't work
- Check that the Live Server extension is properly installed in VS Codium
- Verify that the HTML file exists in the `output/` folder
- Try a different port if 5500 is already in use

### Images don't display
- Check that images are in the `src/images/` folder
- Verify that the image paths in your markdown files are correct
- Make sure the `update-image-paths.lua` filter is included in the Pandoc command

### Styles are not applied
- Check that `style.css` is properly linked in `pagedjs-phd-config.json`
- Verify that all CSS modules are imported in `assets/css/style.css`
- Clear your browser cache and reload the page

### Footnotes/sidenotes/margin-notes rendering issues
- Check the `notes` configuration in `pagedjs-phd-config.json`
- Verify that the corresponding CSS module is imported (footnotes.css, sidenotes.css, or margin-notes.css)
- Make sure the `containerNotes` selector matches your document structure

### Changes don't appear after regenerating
- Check that you're regenerating the correct output file
- Verify that your local server is pointing to the right file
- Try a hard refresh in your browser (Ctrl+Shift+R or Cmd+Shift+R)


  ## Roadmap (to do)

  - Full-page elements support 
  - Endnotes (notes grouped by section instead of footnotes/sidenotes)
  - Web version
  - Enhanced metadata handling in Pandoc template for cover page customization
  - Automatic blank page insertion to ensure page count is multiple of 4 (for booklet printing)